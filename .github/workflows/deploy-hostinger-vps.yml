name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: hostinger-vps-deploy
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Deploy to Hostinger
        uses: hostinger/deploy-on-vps@v2
        with:
          api-key: ${{ secrets.HOSTINGER_API_KEY }}
          virtual-machine: ${{ vars.HOSTINGER_VM_ID }}
          project-name: dub-web
          docker-compose-path: deploy/docker-compose.hostinger.yml
          environment-variables: |
            NODE_ENV=production
            NEXT_PUBLIC_VERCEL_ENV=production
            NEXT_PUBLIC_APP_NAME=${{ vars.NEXT_PUBLIC_APP_NAME || 'Dub' }}
            NEXT_PUBLIC_APP_DOMAIN=${{ vars.NEXT_PUBLIC_APP_DOMAIN }}
            NEXT_PUBLIC_APP_SHORT_DOMAIN=${{ vars.NEXT_PUBLIC_APP_SHORT_DOMAIN }}
            NEXTAUTH_URL=${{ vars.NEXTAUTH_URL }}

            DATABASE_URL=${{ secrets.DATABASE_URL }}
            PLANETSCALE_DATABASE_URL=${{ secrets.PLANETSCALE_DATABASE_URL }}
            NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}

            TINYBIRD_API_KEY=${{ secrets.TINYBIRD_API_KEY }}
            TINYBIRD_API_URL=${{ vars.TINYBIRD_API_URL || 'https://api.tinybird.co' }}

            UPSTASH_REDIS_REST_URL=${{ secrets.UPSTASH_REDIS_REST_URL }}
            UPSTASH_REDIS_REST_TOKEN=${{ secrets.UPSTASH_REDIS_REST_TOKEN }}
            QSTASH_TOKEN=${{ secrets.QSTASH_TOKEN }}
            QSTASH_CURRENT_SIGNING_KEY=${{ secrets.QSTASH_CURRENT_SIGNING_KEY }}
            QSTASH_NEXT_SIGNING_KEY=${{ secrets.QSTASH_NEXT_SIGNING_KEY }}

            RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
            RESEND_WEBHOOK_SECRET=${{ secrets.RESEND_WEBHOOK_SECRET }}
            SMTP_HOST=${{ vars.SMTP_HOST || 'localhost' }}
            SMTP_PORT=${{ vars.SMTP_PORT || '1025' }}
            SMTP_USER=${{ secrets.SMTP_USER }}
            SMTP_PASSWORD=${{ secrets.SMTP_PASSWORD }}

            PLAIN_API_KEY=${{ secrets.PLAIN_API_KEY }}
            PLAIN_WEBHOOK_SECRET=${{ secrets.PLAIN_WEBHOOK_SECRET }}

            PROJECT_ID_VERCEL=${{ secrets.PROJECT_ID_VERCEL }}
            TEAM_ID_VERCEL=${{ secrets.TEAM_ID_VERCEL }}
            AUTH_BEARER_TOKEN=${{ secrets.AUTH_BEARER_TOKEN }}

            STORAGE_ACCESS_KEY_ID=${{ secrets.STORAGE_ACCESS_KEY_ID }}
            STORAGE_SECRET_ACCESS_KEY=${{ secrets.STORAGE_SECRET_ACCESS_KEY }}
            STORAGE_ENDPOINT=${{ secrets.STORAGE_ENDPOINT }}
            STORAGE_BASE_URL=${{ secrets.STORAGE_BASE_URL }}
            STORAGE_PUBLIC_BUCKET=${{ secrets.STORAGE_PUBLIC_BUCKET }}
            STORAGE_PRIVATE_BUCKET=${{ secrets.STORAGE_PRIVATE_BUCKET }}
